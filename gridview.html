<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Grid Demo</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link href="/css/fonts.css" rel="stylesheet" type="text/css">
    <link href="/css/style.css" rel="stylesheet" type="text/css">
    <script src="js/getReddit.js"></script>
    <style>
img{ 
    height: 25vh;
    display: inline-block;
    vertical-align: text-bottom;
    padding: 2px;
}
img.lastInRow{ 
    background: #00BCD4;
}
img.inRow {
    background: #9C27B0;
}
    </style>
</head>
<body>
    <div id="mainContent"></div>
    <script>

var verbose = true;

if(verbose) console.log("Begin");    

//default error handler
function defaultErrorCallback(x){
    if(verbose) console.log("i am the default error callback.");    
    console.log(x);
}

//element builder
function elBuildo(tag,a,text){
    var node = document.createElement(tag);
    var i = 0;
    if(a.length!=0) while(i<(a.length-1)) { node.setAttribute(a[i], a[++i]); i++; }		
    node.innerHTML = text;
    return node;
}

function attachImages(resp){
    var redditBall = JSON.parse(resp);
    console.log(redditBall);

    for (var i = 0; i < redditBall.data.children.length; i++){
        //console.log(redditBall.data.children[i].data);

        mainContent.appendChild(elBuildo("img",[
            "src", redditBall.data.children[i].data.preview.images[0].source.url,
            "title", redditBall.data.children[i].data.title
        ], ""));
    }

    realizeGrid();

}
function realizeGrid(){
    
//set mainContent.height to (anything)
//release mainContent.height (width now perfect)









///while expanse > 10, increase height ->do the whole thing dynamically











    var hold = 0;
    var imgs = document.body.getElementsByTagName("img");
//clear grid
    for (var i = 0; i < imgs.length; i++){
        imgs[i].className = "";  
        imgs[i].removeAttribute("style");
    }   
    for (var i = 0; i < imgs.length; i++){
        //console.log(imgs[i].getBoundingClientRect());
        
    
        if((i+1 < imgs.length && imgs[i].getBoundingClientRect().right > imgs[i+1].getBoundingClientRect().right) || i == imgs.length-1){
    //IS LAST IN ROW
            imgs[i].className = "lastInRow";


            //console.log(imgs[i].getBoundingClientRect().right, mainContent.getBoundingClientRect().right, imgs[i].getBoundingClientRect().right - mainContent.getBoundingClientRect().right);


            //console.log(imgs[i-1]);
            //console.log(imgs[i-1].getBoundingClientRect().right, mainContent.offsetWidth, imgs[i-1].getBoundingClientRect().right - mainContent.offsetWidth);


            var j = 0;
            var row = [];
                row.push(imgs[i]);
            while( ((i) - ++j) >= 0 && !imgs[((i) - j)].classList.contains("lastInRow")){
    //IS IN ROW
                //console.log(j, ((i-1) - j), !imgs[((i-1) - j)].classList.contains("lastInRow"), (i-1) - j);
               // console.log(((i-1) - j), imgs[((i-1) - j)]);
               imgs[(i) - j].className = "inRow";

                row.push(imgs[(i) - j]);
            }

            console.log(row);

            var kill = 500;
            var margin = 10;            
            if(row.length <= 1){
                row[0].style.width = "100%";
                row[0].style.height = "initial";
            }
            else while(mainContent.getBoundingClientRect().right - imgs[i].getBoundingClientRect().right > margin && --kill > 0){
                for (var ii = 0; ii < row.length; ii++){
                    console.log(row[ii].offsetHeight,  row[ii].style.height);
                    row[ii].style.height = row[ii].offsetHeight + 1 + "px";
                    console.log(row[ii].offsetHeight,  row[ii].style.height);
                }
                
                if(row[0].getBoundingClientRect().top > row[1].getBoundingClientRect().top){
                    //while((row[1].getBoundingClientRect().top, row[0].getBoundingClientRect().top > row[1].getBoundingClientRect().top))
                    for (var ii = 0; ii < row.length; ii++){
                        console.log(row[ii].offsetHeight,  row[ii].style.height);
                        row[ii].style.height = (row[ii].style.height - 4) + "px";
                        console.log(row[ii].offsetHeight,  row[ii].style.height);
                    }
                    //console.log(row[0].getBoundingClientRect().top < row[1].getBoundingClientRect().top, row[0].getBoundingClientRect().top, row[1].getBoundingClientRect().top);
                    console.log("BREAK!");
                    break;
                }
                    

                //if(row[0].getBoundingClientRect().top < row[1].getBoundingClientRect().top)
                    //console.log(row[0].getBoundingClientRect().top < row[1].getBoundingClientRect().top);
               // else
                    //console.log(row[0].getBoundingClientRect().top, row[1].getBoundingClientRect().top);
                
                

                //console.log(kill, mainContent.getBoundingClientRect().right, imgs[i].getBoundingClientRect().right, mainContent.getBoundingClientRect().right - imgs[i].getBoundingClientRect().right);
            }
            console.log("break?");

            /*
            var kill = 30;
            while(mainContent.getBoundingClientRect().right - imgs[i].getBoundingClientRect().right > 50 && --kill > 0){
                row.forEach(function (item, index, array) {
                    console.log(item, index);
                });
            }
            */

            //console.log(mainContent.getBoundingClientRect().right, imgs[i].getBoundingClientRect().right, mainContent.getBoundingClientRect().right - imgs[i].getBoundingClientRect().right);
            //var expanse = ((mainContent.getBoundingClientRect().right - imgs[i].getBoundingClientRect().right) / (j));
            //while(j-->0){
            //    console.log("  ", i-j, imgs[i-j].offsetWidth, expanse, imgs[i-j].offsetWidth + expanse);
                //imgs[i-j].style.width = imgs[i-j].offsetWidth + expanse + "px";
                //imgs[i-j].style.width =  (imgs[i-j].offsetWidth+expanse-5) + "px";
                //imgs[i-j].style.height =  "initial";
            //}

            //console.log(mainContent.getBoundingClientRect().right, imgs[i].getBoundingClientRect().right, mainContent.getBoundingClientRect().right - imgs[i].getBoundingClientRect().right);

        }
        
    }

    console.log(mainContent.offsetWidth);
}
window.onresize = realizeGrid;

get("/r/museum", attachImages, defaultErrorCallback);



    </script>
</body>
</html>